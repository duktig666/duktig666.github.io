---
title: 以太坊
date: 2022-03-23
publish: false
---

## 什么是以太坊？

以太坊的目的主要不是数字货币支付网络。但数字货币*ether*对于以太坊的运作来说既是不可或缺的也是必要的，以太也被视为一种*实用货币*来支付以太坊平台的使用。

与具有非常有限的脚本语言的比特币不同，以太坊被设计成一个通用可编程区块链，运行一个*虚拟机*，能够执行任意和无限复杂的代码。

以比特币为基础意味着处于网络的有意约束之中，并试图找到解决方法。数据存储的有限类型和大小似乎限制了可以在其上作为第二层解决方案运行的应用程序的类型。

将以太坊视为**构建可编程金钱的平台**。

以太坊的创始人们正在考虑一个**并非针对特定目的的区块链，而是通过成为*可编程的*来支持各种各样的应用**。



原始区块链（比特币的区块链）追踪比特币单位的状态及其所有权。你可以将比特币视为分布式共识 *状态机*，其中交易引起全局的_状态转移 _，从而更改比特币的所有权。状态转移受共识规则的制约，允许所有参与者（最终）在开采数个区块后在系统的共同（共识）状态上汇合。

以太坊也是一个分布式状态机。但是，**不仅仅追踪货币所有权的状态，以太坊追踪通用数据存储的状态转换**。

以太坊的突破性创新是将存储程序计算机的通用计算架构与去中心化区块链相结合，从而创建分布式单状态（单例）世界计算机。以太坊程序“到处”运行，但却产生了共识规则所保证的共同（共识）状态。



以太坊是图灵完备的事实意味着任何复杂的程序都可以在以太坊中计算。但是这种灵活性带来了一些棘手的安全和资源管理问题。

为了应对这一挑战，以太坊引入了称为 *燃气* *gas*的计量机制。随着EVM执行智能合约，它会仔细考虑每条指令（计算，数据访问等）。每条指令都有一个以燃气为单位的预定成本。当交易触发智能合约的执行时，它必须包含一定量的燃气，用以设定运行智能合约可消耗的计算上限。如果计算所消耗的燃气量超过交易中可用的天然气量，则EVM将终止执行。Gas是以太坊用于允许图灵完备计算的机制，同时限制任何程序可以使用的资源。



在比特币中，开发以保守原则为指导：所有变化都经过仔细研究，以确保现有系统都不会中断。大部分情况下，只有在向后兼容时才会执行更改。允许现有客户“选择加入”，但如果他们决定不升级，将继续运作。

相比之下，在以太坊中，开发文化的重点是速度和创新。这个咒语是“快速行动，解决事情”。如果需要进行更改，即使这意味着使之前的假设失效，破坏兼容性或强制客户端进行更新，也会执行更改。以太坊的开发文化的特点是快速创新，快速进化和愿意参与实验。

这对开发者来说意味着什么，**就是你必须保持灵活性，随着一些潜在的假设变化，准备重建你的基础设施**。



## 基础

以太坊的货币单位称为 *以太* *ether*，也被称为ETH。以太被细分为更小的单位，直到可能的最小单位，这被命名为*wei*，一个 ether 是 1×10^18^ 。

你可能会听到人们也提到货币“以太坊”，但这是一个常见的初学者的错误。**以太坊是制度，以太是货币**。

以太坊钱包是你通往以太坊系统的门户。它拥有你的密钥，并且可以代表你创建和广播交易。



**为什么交易不成功？**

你可能注意到你无法完成交易。MetaMask表示“交易余额不足”。乍一看这可能会让人困惑：我们有1个ETH，我们想要发送1个ETH，为什么MetaMask说我们没有足够的资金？

答案是因为*gas*的成本。以太坊交易需要支付矿工收取的费用，以验证交易。以太坊的费用以*gas*虚拟货币收取。作为交易的一部分，你使用ether支付gas。



小结：

**以太坊合约是控制货币的程序，运行在名为EVM的虚拟机内。它们是由一个特殊的交易创建的，该交易提交它们的字节码以记录在区块链中。一旦他们在区块链上创建，他们就拥有一个以太坊地址，就像钱包一样**。

**只要有人将交易发送到合约地址，它就会导致合约在EVM中运行，并将交易作为其输入。发送到合约地址的交易可能包含以太坊或数据或两者都有。如果它们含有ether，则将其“存入”合约余额。如果它们包含数据，则数据可以在合约中指定一个命名函数并调用它，并将参数传递给该函数。**



## 以太坊客户端

以太坊客户端是实现以太坊规范并通过对等网络与其他以太坊客户端进行通信的软件应用程序。

[go-ethereum](https://github.com/ethereum/go-ethereum)

构建（linuix）：

```sh
cd go-ethereum
make geth
```

[Win10使用Geth客户端搭建以太坊私有链](https://blog.csdn.net/Tree_sea/article/details/121990419)



**JSON-RPC接口**

以太坊客户端提供应用程序编程接口（API）和一组远程过程调用（RPC）命令，这些命令被编码为JavaScript对象表示法（JSON）。这被称为*JSON-RPC API*。本质上，JSON-RPC API是一个接口，允许我们将使用以太坊客户端的程序作为*gateway*编写到以太坊网络和区块链中。

通常，RPC接口作为端口8545上的HTTP服务提供。

要访问JSON-RPC API，可以使用专门的库，用你选择的编程语言编写，它提供与每个可用的RPC命令相对应的“桩（stub）”函数调用。

测试：

```sh
curl -X POST -H "Content-Type: application/json" --data \
'{"jsonrpc":"2.0","method":"web3_clientVersion","params":[],"id":1}' \
http://localhost:8545
```

结果：

```json
{"jsonrpc":"2.0","id":1,
 "result":"Geth/v1.8.0-unstable-02aeb3d7/linux-amd64/go1.8.3"}
```



## 秘钥和地址

以太坊有两种不同类型的账户，可以拥有和控制ether：*外部所有账户*（EOA）和*合同*。

EOAs中以太的所有权通过 *数字密钥* *digital keys*，*以太坊地址*和*数字签名* 建立 。**数字密钥实际上并不存储在区块链中或在以太坊网络上传输，而是由用户创建并存储在文件或称为*钱包*的简单数据库中**。用户钱包中的数字密钥完全独立于以太坊协议，可以由用户的钱包软件生成和管理，无需参考区块链或访问互联网。数字密钥可实现以太坊的许多有趣特性，包括去中心化的信任和控制以及所有权证明。

以太坊交易需要将有效的数字签名包含在区块链中，该签名只能使用密钥生成；因此，任何拥有该密钥副本的人都可以控制ether。**以太坊交易中的数字签名证明了资金的真正所有者**。

**数字密钥成对组成，密钥和公钥。将公钥视为类似于银行帐号，私钥类似于私密PIN，用于控制帐户**。以太坊的用户很少看到这些数字密钥。在大多数情况下，它们存储在钱包文件内并由以太坊钱包软件管理。

以太坊在许多地方使用*Keccak-256*加密哈希函数。



以太坊地址是 *唯一标识符* *unique identifiers*，它们是使用单向哈希函数（Keccak-256）从公钥或合约派生的。

以太坊地址是十六进制数字，从公钥的Keccak-256哈希的最后20个字节导出的标识符。

## 钱包

关于以太坊的一个常见误解是以太坊钱包包含ether或代币。实际上，钱包只包含密钥。ether或其他代币记录在以太坊区块链中。用户通过使用钱包中的密钥签署交易来控制网络上的代币。从某种意义上说，以太坊钱包是一个 *钥匙串* *keychain*。

有两种主要类型的钱包，通过它们包含的密钥是否彼此相关来区分。

第一种类型是 *非确定性钱包* *nondeterministic wallet*，其中每个密钥都是从随机数中独立生成的。密钥不相互关联。这种类型的钱包也被称为“Just a Bunch Of Keys”，JBOK钱包。

第二种类型的钱包是 *确定性钱包* *deterministic wallet*，其中所有密钥都来自单个主密钥，称为*种子* *seed*。这种类型的钱包中的所有钥匙都是相互关联的，如果有原始种子，可以再次生成。确定性钱包中使用了许多不同的 *密钥推导方法。最常用的派生方法使用树状结构，称为 _分层确定* *hierarchical deterministic*或*HD*钱包。

确定性钱包是从种子初始化的。为了使这些更容易使用，种子被编码为一些英文单词（或其他语言的词），称为 *mnemonic code* 助记词，接下来的几节将从较高的层次介绍这些技术。

## 交易

**交易是由外部所有帐户发起的签名消息，由以太坊网络传输，并在以太坊区块链上进行记录（挖掘）**。

看待交易的另一种方式是，它们是唯一可触发状态更改或导致合约在EVM中执行的东西。以太坊是一个全球的单实例状态机器，交易是唯一可以让状态机“运动”，改变状态的东西。合约不会自行运行。以太坊不会在后台运行。一切都始于交易。

### 交易的结构

交易是一个序列化的二进制消息，其中包含以下数据：

- nonce

  由始发EOA（外部所有账户）发出的序列号，用于防止消息重播。

- gas price

  发起人愿意支付的gas价格（以wei为单位）。

- start gas

  发起人愿意支付的最大gas量。

- to

  目标以太坊地址。

- value

  发送到目标地址的ether数量。

- data

  变长二进制数据。

- v,r,s

  始发EOA的ECDSA签名的三个组成部分。

### 交易随机数

nonce是交易中最重要和最少被理解的组成部分之一。

nonce：与此地址发送的交易数量相等的标量值，或者，对于具有关联代码的帐户，表示此帐户创建的合约数量。

严格地说，nonce是始发地址的一个属性（它只在发送地址的上下文中有意义）。但是，该nonce并未作为账户状态的一部分显式存储在区块链中。相反，它是根据来源于此地址的已确认交易的数量动态计算的。

**nonce值也用于防止帐户余额的错误计算**。

**跟踪nonce**：

实际上，nonce是源自帐户的 *已确认*（已开采）交易数量的最新计数。要找到nonce是什么，你可以询问区块链，例如通过web3界面：

Retrieving the transaction count of our example address：

```
web3.eth.getTransactionCount("0x9e713963a92c02317a681b9bb3065a8249de124f")
40
```

该nonce是一个基于零的计数器，意味着第一个交易的nonce是0.在 [Retrieving the transaction count of our example address](https://www.8btc.com/books/834/ethereum-book/_book/第七章.html#nonce_getTransactionCount)中，我们有一个交易的计数为40，这意味着从0到39nonce已经被看到。下一个交易的nonce将是40。

你的钱包将跟踪其管理的每个地址的nonce。

**nonce的间隔，重复的nonce和确认**：

如果你正在以编程方式创建交易，跟踪nonce是十分重要的，特别是如果你同时从多个独立进程执行此操作。

以太坊网络根据nonce顺序处理交易。这意味着如果你使用nonce 0传输一个交易，然后传输一个具有nonce 2的交易，则第二个交易将不会被挖掘。它将存储在mempool中，以太坊网络等待丢失的nonce出现。所有节点都会假设缺少的nonce只是延迟了，具有nonce 2的交易被无序地接收到。

这意味着如果你按顺序创建多个交易，并且其中一个交易未被挖掘，则所有后续交易将“卡住”，等待丢失的事件。

**并发，交易的发起和随机数**

现在，假设我们有多个独立的钱包应用程序正在从同一个地址或同一组地址生成交易。这种情况的一个例子是从热钱包进行提款的交易所。理想情况下，你希望有多台计算机处理提款，以便它不会成为瓶颈或单点故障。然而，这很快就会成为问题，因为有多台计算机生产提款会导致一些棘手的并发问题，其中最重要的是选择nonce。多台电脑如何从同一个热钱包账户协调生成，签署和广播交易？

### 交易gas

**gas是以太坊的燃料。gas不是ether，它是独立的虚拟货币，有相对于ether的汇率**。

以太坊使用gas来控制交易可以花费的资源量，因为它将在全球数千台计算机上处理。开放式（图灵完备的）计算模型需要某种形式的计量，以避免拒绝服务攻击或无意中的资源吞噬交易。

gas与ether分离，以保护系统免受随着ether价值快速变化而产生的波动。

钱包可以在他们发起的交易中调整 gasPrice，以更快地确认（挖掘）交易。gasPrice 越高，交易可能被验证的速度越快。相反，较低优先级的交易可能会降低他们愿意为gas支付的价格，导致确认速度减慢。可以设置的最低gasPrice 为零，这意味着免费的交易。在区块空间需求低的时期，这些交易将被开采。

### 交易的接收者

交易的收件人在to字段中指定。这包含一个20字节的以太坊地址。地址可以是EOA或合约地址。

以太坊没有进一步验证这个字段。任何20字节的值都被认为是有效的。如果20字节的值对应于没有相应私钥的地址，或没有相应的合约，则该交易仍然有效。以太坊无法知道某个地址是否是从公钥（从私钥导出的）正确导出的。

### 交易的价值和数据

**交易的主要“负载”包含在两个字段中：value 和 data**。交易可以同时具有value和data，只有value，只有data，或没有value和data。所有四种组合都是有效的。

**将value传递给EOA和合约：**

当你构建包含 value 的以太坊交易时，它等同于*payment*。

对于未在区块链中注册为合约的任何地址，以太坊将记录状态更改，并将你发送的value添加到地址的余额中。如果地址之前没有被查看过，则会创建地址并将其余额初始化为你的付款value。

**将数据传输到EOA或合约**：

现在，假设你的交易是向合约地址提供 data。在这种情况下，data 将被EVM解释为 *函数调用* *function invocation*，调用指定的函数并将任何编码参数传递给该函数。

### 特殊交易：合约注册

有一种特殊的带有data，没有value的交易。表示注册一个新的合约。合约登记交易被发送到一个特殊的目的地地址，即零地址。简而言之，合约注册交易中的to字段包含地址 0x0。该地址既不代表EOA（没有相应的私人/公共密钥对）也不代表合约。它永远不会花费ether或启动交易。它仅用作目的地，具有“注册此合约”的特殊含义。

### 数字签名

数字签名在以太坊中有三种用途（请参阅下面的边栏）。首先，签名证明私钥的所有者，暗示着以太坊账户的所有者，已经授权支付ether或执行合约。其次，授权的证明是*undeniable*（不可否认）。第三，签名证明交易数据在交易签名后没有也不能被任何人修改。

数字签名是一种数学签名，由两部分组成。第一部分是使用私钥（签名密钥）从消息（交易）中创建签名的算法。第二部分是允许任何人仅使用消息和公钥来验证签名的算法。

## 智能合约

以太坊有两种不同类型的账户：外部所有账户（EOAs）和合约账户。EOAs由以太坊以外的软件（如钱包应用程序）控制。合约帐户由在以太坊虚拟机（EVM）内运行的软件控制。两种类型的帐户都通过以太坊地址标识。

“智能合约”来指代在Ethereum虚拟机环境中确定性的运行的不可变的计算机程序，该虚拟机作为一个去中心化的世界计算机而运转。

**智能合约的生命周期**

智能合约通常以高级语言编写，一旦编译完成，它们就会随着转移到特殊的合约创建地址的交易被部署到以太坊区块链中。每个合约都由以太坊地址标识，该地址源于作为发起账户和随机数的函数的合约创建交易。合约的以太坊地址可以在交易中用作接收者，可将资金发送到合约或调用合约的某个功能。

**重要的是**，如果合约只有被交易调用时才会运行。以太坊的所有智能合约均由EOA发起的交易执行。合约可以调用另一个合约，其中又可以调用另一个合约，等等。但是这种执行链中的第一个合约必须始终由EOA的交易调用。合约永远不会“自行”运行，或“在后台运行”。**在交易触发执行，直接或间接地作为合约调用链的一部分之前，合约在区块链上实际上是“休眠”的**。

**交易是 *原子性的* *atomic*，无论他们调用多少合约或这些合约在被调用时执行的是什么。交易完全执行，仅在交易成功终止时记录全局状态（合约，帐户等）的任何更改**。成功终止意味着程序执行时没有错误并且达到执行结束。如果交易由于错误而失败，则其所有效果（状态变化）都会“回滚”，就好像交易从未运行一样。**失败的交易仍存储在区块链中，并从原始账户扣除gas成本，但对合约或账户状态没有其他影响**。

**合约的代码不能更改。然而合约可以被“删除”，从区块链上删除代码和它的内部状态（变量）**。

## 代币（Tokens）

单词*Token*来源于古英语“tacen”，意思是符号或符号。常用来表示私人发行的类似硬币的物品，价值不大，例如交通Token，洗衣Token，游乐场Token。

如今，基于区块链的Token将这个词重新定义为基于区块链的抽象概念，可以被拥有，并代表资产，货币或访问权。

### 如何使用Token？

Token最明显的用途是作为数字私人货币。但是，这只是一个可能的用途。

- 货币：Token可以作为一种货币形式，其价值通过私人交易来确定。例如，ether或bitcoin。
- **资源**：Token可以表示在共享经济或资源共享环境中获得或生成的资源。例如，表示可通过网络共享的资源的存储或CPU的Token。
- **资产**：Token可以代表内在或外在，有形或无形资产的所有权。例如，黄金，房地产，汽车，石油，能源等。
- **访问**：Token可以代表访问权限，可以访问数字或实体资产，例如论坛，专属网站，酒店房间，租车。
- **权益**：Token可以代表数字组织（例如DAO）或法律虚拟主体（例如公司）中的股东权益。
- **投票**：Token可以代表数字或法律系统中的投票权。
- **收藏品**：Token可以代表数字（例如CryptoPunks）或物理收藏品（例如绘画）
- **身份**：Token可以代表数字（例如头像）或合法身份（例如国家ID）。
- **证明**：Token可以代表某些机构或去中心化的信用系统（例如婚姻记录，出生证明，大学学位）的认证或事实证明。
- **实际用途**：Token可用于访问或支付服务。

通常，单个Token包含其中几个功能。有时它们之间很难辨别，因为物理等价物一直是密不可分的。例如，在物理世界中，驾驶执照（认证）也是身份证件（身份证明），两者不能分开。在数字领域，以前的混合功能可以独立分离和开发（例如匿名认证）。

### 不可互换性

不可互换的Token是代表独特的有形或无形商品的Token，因此不可互换。例如，表示*特定的* Van Gogh绘画所有权的Token不等同于代表毕加索的另一个Token。同样，表示特定数字收藏的Token，如特定的CryptoKitty（请参阅[[cryptoKitties\]](https://www.8btc.com/books/834/ethereum-book/_book/第十章.html#cryptoKitties)）与任何其他CryptoKitty都不可互换。每个不可互换的Token与唯一标识符相关联，例如序列号。

### 交易对手风险

由于在交易中增加了两个以上的交易方，某些类型的交易会产生额外的交易对手风险。例如，如果你持有贵金属存款证明并将其出售给某人，则该交易中至少有三方：卖方，买方和贵金属的保管人。有人持有有形资产，必要时他们成为一方并为涉及该资产的任何交易添加交易对手风险。

**当资产通过交换所有权信息而间接交易时，资产托管人有额外的交易对手风险。他们有资产吗？他们是否会根据Token的转让（例如证书，契约，所有权或数字Token）识别（或允许）所有权的转移？**在数字Token的世界中，了解谁持有由Token表示的资产以及适用于该基础资产的规则很重要。



## 去中心化应用 (DApps)

点对点（P2P，peer-to-peer）运动使数百万互联网用户能够连接在一起。

与传统应用程序不同，去中心化应用（DApp）不仅属于单个提供者或服务器，而是整个栈将在P2P网络上以分布式方式部署和操作。

典型的DApp栈包括前端，后端和数据存储。

创建DApp有许多优点，典型集中式架构无法提供：

1）弹性：在智能合约上编写业务逻辑意味着DApp后端将在区块链上完全分发和管理。与在中央服务器上部署应用程序不同，DApp不会有停机时间，只要区块链仍在运行，它就会继续存在。

2）透明性：DApp的开源特性允许任何人分叉代码并在区块链上运行相同的应用程序。同样，任何与区块链的互动都将永久存储，任何拥有区块链副本的人都可以获得对它的访问权限。值得注意的是，可能无法将字节码反编译为源码并完全理解合约的代码。寻求提供合约行为完全透明的开发人员必须发布供用户阅读，编译和验证的源代码。

3）抗审查：只要用户可以访问以太坊节点，用户将始终能够与DApp交互而不受集中机构控制的干扰。一旦在网络上部署代码，任何服务提供商，甚至智能合约的所有者都不能更改代码。

### DApp的组件

#### 区块链（智能合约）

智能合约用于存储去中心化应用程序的业务逻辑，状态和计算; 将智能合约视为常规应用程序中的服务器端组件。

在以太坊智能合约上部署服务器端逻辑的一个优点是，**你可以构建一个更复杂的架构，智能合约可以在其中相互读取和写入数据。部署智能合约后，未来许多其他开发人员都可以使用你的业务逻辑，而无需你管理和维护代码**。

**将智能合约作为核心业务逻辑功能运行的一个主要问题是在部署代码后无法更改代码**。此外，一个非常庞大的智能合约可能需要耗费大量gas来部署和运行。因此，某些应用程序可能会选择离线计算和外部数据源。请记住，DApp的核心业务逻辑依赖于外部数据或服务器意味着你的用户必须信任这些外部事物。

#### 前端（Web用户界面(UI)）

DApp的客户端界面使用基本的Web前端技术（HTML，CSS，JavaScript）。这允许传统的Web开发人员使用他们熟悉的工具，库和框架。与DApp的交互（例如签名消息，发送交易和密钥管理）通常通过浏览器本身使用Mist浏览器或Metamask浏览器扩展等工具进行。

#### 数据存储

由于gas成本高，智能合约目前不适合存储大量数据。因此，大多数DApps将利用去中心化存储（如IPFS或Swarm）来存储和分发大型静态资产，如图像，视频和客户端应用程序（HTML，CSS，JavaScript）。

内容的哈希值通常使用键值映射存储为智能合约中的字节。然后，通过你的前端应用程序调用智能合约检索资产，以获取每个资产的URL。

## 预言机（Oracles）

以太坊虚拟机的一个关键属性是**它能够以完全确定的方式执行智能合约字节码**。

EVM保证相同的操作将返回相同的输出，而不管它们实际运行的计算机。这一特性虽然是以太坊安全保证的关键，但它通过阻止智能合约检索和处理脱链数据来限制智能合约的功能。

但是，许多区块链应用程序需要访问外部信息。这就是**oracles**发挥作用的地方。可以将Oracles定义为离线数据的权威来源，允许智能合约使用外部信息接收和条件执行 - 它们可以被视为弥合链上链下之间鸿沟的机制。

oracle可以实现为链上智能合约系统和用于监控请求，检索和返回数据的离线基础设施。来自去中心化应用的数据请求通常是涉及许多步骤的异步过程。

## 燃气（gas）

**Gas**是以太坊用于衡量程序执行一个或一组动作所需计算量的单位。交易或合约执行的每项操作都需要一定数量的gas; 所需的gas数量与正在执行的计算步骤的类型和数量有关。

与仅以千字节（kB）计算交易规模的比特币交易费相比，以太坊交易费必须考虑智能合约代码可以执行的任意数量的计算步骤。程序执行的操作数越多，运行完成的成本就越高。

每次操作都需要固定量的gas。以太坊黄皮书的的一些例子：

- 添加两个数字需要3个gas
- 计算Keccak256哈希值，需要30个gas+ 每256位数据被哈希6个gas
- 发送交易成本为21000 gas

gas是以太坊的重要组成部分，具有双重作用。一，作为以太坊价格（具有波动性）和矿工对其工作的奖励之间的抽象层。另一种是抵御拒绝服务攻击。为了防止网络中的意外或恶意无限循环或其他计算浪费，每个交易的发起者需要设置他们愿意花费在gas上的金额的限制。因此，gas系统阻止攻击者发送垃圾邮件交易，因为他们必须按比例支付他们消耗的计算，带宽和存储资源。

### 停机问题

交易费和会计的想法似乎很实用，但你可能想知道为什么以太坊首先需要gas。gas是关键，因为它不仅可以解决停机问题，而且对安全和活力也至关重要。什么是停机问题，安全和活力，为什么要关心？

### 支付gas

虽然gas有价格，但它不能“拥有”也不能“花”。**gas仅存在于以太坊虚拟机（EVM）内部，作为计算工作量的计数。发起方被收取ether交易费，然后转换为gas，然后转回到ether，作为矿工的块奖励。**这些转换步骤用于将计算的价格（与“工作量”相关）与ether的价格（与市场波动相关）分开。

### gas成本与gas价格

虽然**gas成本**是EVM中执行的操作步骤的度量，但gas本身也具有以ether测量的**gas价格**。在执行交易时，发起方指定他们愿意为每个gas单位支付的gas价格（以ether为单位），允许市场决定ether的价格与计算操作的成本之间的关系（以gas衡量） 。

`total gas used * gas price paid = transaction fee`，以ether为单位

此金额将在交易执行开始时从发起方的帐户中扣除。发起方不是设置“total gas used”，而是设置**gas limit**，该限制应足以覆盖执行交易所需的gas量。

### gas成本限制和gas耗尽

在发送交易之前，发起方必须指定**gas limit** - 他们愿意购买的最大gas数量。他们还必须指定**gas price** - 他们愿意为每单位gas支付的以太价格。

以ether计算的`gas limit * gas price`在交易执行开始时从发起方的账户中扣除作为存款。这是为了防止发送者在执行中期“破产”并且无法支付gas费用。由于这个原因，用户也无法设置超出其帐户余额的gas限制。

理想情况下，发起方将设置一个高于或等于实际使用的gas的gas限制。如果gas限制设置高于消耗的gas量，发货人将收到超额金额的退款，因为矿工只获得他们实际工作的补偿。

在这种情况下：

`（gas限制 - 多余gas）*gas价格` 以太以矿块作为块奖励

`(gas limit - excess gas) * gas price` ether作为矿工的区块奖励

`excess gas * gas price` ether退回发起方

但是，如果使用的gas超过规定的gas限制，即如果在执行期间交易“runs out of gas”，则操作终止。虽然交易不成功，但由于矿工已经完成了计算工作，不会退回发送人的交易费用，矿工因此得到补偿。

### 估算 Gas

通过假装交易已经被包含在区块链中来估算gas，然后返回如果操作是真实的那么可以收取的确切gas量。换句话说，它使用与矿工用来计算实际费用但从未开采过区块链的完全相同的程序。

请注意，由于各种原因（包括EVM机制和节点性能），估计值可能远远超过交易实际使用的gas量。

```javascript
var result = web3.eth.estimateGas({
    to: "0xc4abd0339eb8d57087278718986382264244252f",
    data: "0xc6888fa10000000000000000000000000000000000000000000000000000000000000003"
});
console.log(result); // "0x0000000000000000000000000000000000000000000000000000000000000015"
```

### gas价格和交易优先顺序

gas价格是交易发起方愿意为每个gas单位支付的ether量。开采下一个区块的矿工决定要包括哪些交易。**由于gas价格被计入他们将作为奖励的交易费中，他们更可能首先包括具有最高gas价格的交易。如果发起方将gas价格设置得太低，他们可能需要等待很长时间才能将其交易进入一个区块。**

**矿工还可以决定块中包含交易的顺序**。由于多个矿工竞争将其区块附加到区块链，因此区块内的交易顺序由“获胜”矿工任意决定，然后其他矿工用该订单核实。虽然可以任意排列来自不同账户的交易，但是来自个人账户的交易是按照自动递增的随机数的顺序执行的。

### 区块gas限制

区块gas限制是区块中允许的最大gas量，用于确定区块中可以容纳的交易数量。

例如，假设我们有5个交易，其中每个交易的gas限制为10,20,30,40和50.如果区块gas限制为100，那么前四个交易可以适合该区块，而交易5必须等待未来的区块。

如前所述，矿工决定在一个区块中包含哪些交易。不同的矿工可以尝试包括块中的最后2个交易（50 + 40），并且它们仅具有包括第一个交易（10）的空间。如果你尝试包含的交易需要的gas量超过当前的gas限制，则网络将拒绝该交易，你的以太坊客户将向你发送消息“交易超过区块gas限制。

根据https://etherscan.io的数据，目前区块的gas限制在500万左右。即一个区块可以容纳约238个交易，每个交易消耗21000个gas。

### 谁来决定区块gas限制是多少？

网络上的矿工决定区块gas限制是什么。

### gas退款

以太坊通过退还高达一半的gas费用来鼓励删除存储的变量。 EVM中有2个负的gas操作：

清理合约是-24,000（SELFDESTRUCT） 清理存储为-15,000（SSTORE [x] = 0）

**GasToken**

GasToken是一种符合ERC20标准的token，允许任何人在gas价格低时“储存”gas，并在gas价格高时使用gas。通过使其成为可交易的资产，它基本上创造了一个gas市场。 它的工作原理是利用前面描述的gas退款机制。

### 租金

目前，以太坊社区提出了一项关于向智能合约收取“租金”以保持活力的建议。

在没有支付租金的情况下，智能合约将被“睡眠”，即使是简单的读取操作也无法获得数据。需要通过支付租金和提交Merkle证据来唤醒进入睡眠状态的合约。

## 以太坊虚拟机

实际处理内部状态和计算的协议部分称为以太坊虚拟机（EVM）。从实际角度来看，EVM可以被认为是包含数百万个对象的大型去中心化计算机。

### 比较

- 虚拟机（Virtual Machine）（Virtualbox, QEMU, 云计算）
- Java 虚拟机（VM）

虚拟机技术（如Virtualbox和QEMU / KVM）与EVM的不同之处在于它们的目的是提供管理程序功能，或者处理客户操作系统与底层主机操作系统和硬件之间的系统调用，任务调度和资源管理的软件抽象。

然而，Java VM（JVM）规范的某些方面确实包含与EVM的相似之处。从高级概述来看，JVM旨在提供与底层主机操作系统或硬件无关的运行时环境，从而实现各种系统的兼容性。在JVM上运行的高级程序语言（如Java或Scala）被编译到相应的指令集字节码中。这与编译要在EVM上运行的Solidity源文件相当。

## 共识

**以太坊网络中的共识是指多个节点或代理在给定的时间点就区块链状态达成一致的能力**。

**当涉及区块链上分散记录保存和验证的核心功能时，单独依靠信任来确保添加到账本的信息是正确的可能会成为问题。这种挑战在去中心化网络中更为明显，因为没有中央实体来决定什么应该和不应该被视为是真实的。缺乏一个中央决策实体是区块链受欢迎程度的主要吸引力之一，因为系统能够抵抗审查制度，并且无需对许可或信息获取权限的依赖**。

然而，这些好处可能带来成本，因为如果没有可信的仲裁员，任何分歧，欺骗或差异都需要使用数学，经济或社会技术进行协调。因此，分散的系统更有抵御攻击的能力，但在应对变化时却不那么果断。

### 共识度量

共识度量是可测量的数据，区块链网络的节点必须在该数据上达成一致，以便为每个块中包含的数据建立并保持一致。

在区块链技术中，每次将新块添加到链中时，每个网络节点都会测量并批准一致性度量。

作为共识度量的结果，区块链充当了从一个确定可验证的事实延伸到下一个事实的真理链。由于共识度量，区块链协议的节点变为 *迷你公证人* *mini-notaries*，能够从真实的节点中立即分辨出区块链的错误副本，并将该事实报告给整个网络。

这些措施是必需的，以便阻止通过提交包含虚假信息的区块来欺骗网络不良行为者。由于一致性度量，区块链不仅建立了的完整性，而且长期保持不变。共识度量有多种形式，但对于此讨论而言，最重要的两种是基于风险的度量和基于工作量的度量。

### 基于Hash的度量（PoW）

**通常称为工作量证明（PoW）度量，这些度量建立了共识，因为使用它们的协议将计算机设置为查找难题的答案**。找到适合网络参数的散列的难题要求节点提交处理能力并使用电力与其他节点竞争以提出有效的哈希。

计算机网络的唯一工作类似于搜索另一种称为SHA-256哈希的数字的可能数字。这些数字具有独特的属性，就像素数一样，尽管在生成符合网络设定标准的哈希方面存在很大困难，但在发现时可以轻松验证它们。想象计算哈希和验证哈希的一种方法是使用拼图游戏类比。这个难题非常困难且耗时，但是一眼就能看出它是否已经完成。

当准确计算SHA-256哈希值时，它们可用作证明已使用一定量的计算能力来查找数字的证明。最新的素数是asciimath：[2^(77,232,917）- 1]。它是由计算机发现的，就像计算机发现的SHA-256哈希一样。SHA-256哈希比新素数更容易找到，但是找到哈希的固有难点在于基于哈希的度量得出它们的能力。

### 基于哈希的度量验证

如果你对足够多的随机短语进行了哈希，有点像打字机上的猴子，最终你会发现一个匹配特定模式的哈希。在哈希为“ya”的情况下，请注意它以模式“666”开头。这类似于比特币，但比特币要求找到与以“000”开头的模式匹配的哈希值。可以通过将前一个区块中的信息插入到SHA-256哈希算法中来创建的任何哈希，并用于创建下一个块，只要它在数字中具有正确数量的前导零，网络就会认可，并且区块奖励将是你的。

由于想要挖掘比特币的人数不断增加，因此每秒寻找SHA-256哈希值的算力总是越来越多。比特币软件通过自动调整共识度量的难度来处理这种意外事件，增加前导零的数量以形成共识。这可以保证新块的创建时间与前面的块大致相同。对于比特币网络，为十分钟，但可以轻松更改。在以太坊中，平均区块生成时间约为10秒。

## 基于风险的度量（PoS）

通常称为Proof-of-Stake（PoS）度量，这些度量基于以下事实建立共识：选择创建无效区块的每个人都会失去比通过创建有效区块获得的更多的东西。该度量是通过关于链内数据的共识创造的，而不是关于链外数据的共识。基于哈希的共识度量主要关注SHA-256哈希的质量和精确性。基于风险的度量主要关注任何特定节点在添加新块时所承担的风险。

所有节点在这里达成一致的度量是哪些节点创建了正确的块，哪些节点没有。

工作量证明是一种共识协议，它将网络中的有效区块链视为创建计算成本最高的链。这里提到的计算工作是将所有块添加到当前区块链所必须完成的工作。这项工作由网络节点完成，并且必须在计算上很困难，以便使工作变得非常重要，但也必须是可行的，以便在经过合理的努力之后可以实现。最终，网络将依赖于提供此PoW的节点以维持区块链，因此，网络的最佳利益是需要合理的PoW。

在以太坊网络以及许多其他区块链网络中，获取PoW需要找到要添加到区块链的块的哈希。这个哈希是通过散列由块的数据和随机数组成的字符串获得的（创建此字符串的方法可能会有所不同，但整个过程是相同的）。该哈希必须小于某个阈值（由网络的难度确定），并且一旦节点发现产生该哈希的随机数，则接受相应的块并将其添加到区块链中。

找到这个有效散列的方法是修改nonce，通常将其初始化为零并在每次迭代时递增，直到产生低于网络阈值的哈希。此过程称为挖掘。由于挖掘中使用的哈希函数的性质，找到有效随机数的唯一方法是通过暴力搜索，即检查随机数的每个可能值，直到找到满足网络要求的散列。因此，提供有效的随机数被认为是PoW。

### PoS

权益证明（PoS，Proof-of-Stake）是公共区块链的一类共识算法，它依赖于验证者在网络中的经济利益。在基于工作量证明（PoW）的公共区块链（例如比特币和以太坊的当前实现）中，该算法奖励解密加密谜题的参与者，以便验证交易并创建新的块（即挖掘）。在基于PoS的公共区块链中（例如以太坊即将发布的Casper实现），一组验证者轮流对下一个块进行建议和投票，每个验证者的投票权重取决于其存款的大小（即赌注）。PoS的显着优势包括安全性，降低集中风险和能源效率。

通常，权益证明算法如下。区块链跟踪一组验证者，任何持有区块链基本加密货币的人（在以太坊的情况下是ether）都可以通过发送一种特殊类型的交易来将其以太币锁定到存款中，从而成为验证者。然后，通过所有当前验证者都可以参与的一致性算法来完成创建和同意新块的过程。

有许多种共识算法，以及许多方法可以为参与共识算法的验证人分配奖励，因此有许多“口味”的权益证明。从算法的角度来看，有两种主要类型：基于链的权益证明和BFT风格的权益证明。

- 在基于链的证明中，算法在每个时隙中伪随机地选择一个验证者（例如，每个10秒的周期可能是一个时隙），并为该验证者分配创建单个块的权限，这个块必须指向一些前一个块（通常是前一个最长链末端的块），因此随着时间的推移，大多数块会聚成一个不断增长的链。
- 在BFT风格的股权证明中，验证者被随机分配提出区块的权利，但是通过多轮过程来确定哪个区块是规范的，其中每个验证者在每轮中发送对某个特定区块的“投票”，在流程结束时，所有（诚实和在线）验证者永久同意任何给定的块是否属于链条的一部分。请注意，块可能仍然链接在一起; 关键的区别在于块上的共识可以在一个块内，并且不依赖于它之后的链的长度或大小。



## Staking

**当前领先的区块链网络正在经历从工作量证明 (PoW) 到权益证明 (PoS) 共识机制的大规模转变**。最初由中本聪 倡导的 PoW 模型已经失宠，批评者指出，PoW 的安全模型和中心化矿池趋势造成了负外部性。取而代之的是，PoS 设计因其能源效率和更好的去中心化承诺而正经历着巨大的发展。

### PoS背景

一个无须许可的区块链网络要想正常运作，那么在任何给定时间只能有一个实体可以**更新该网络的共享账本**。

共识机制是这样一组规则，即区块链网络中的安全性提供者使用这组规则来确定该网络应该采用哪个参与者的更新。在任何时候负责将一系列交易 (区块) 添加进账本中的实体被称为「**区块生产者**」。作为生产新区块并因此维护网络安全性的回报，区块生产者能够从网络中赚取区块奖励。

PoW 和 PoS 是当今区块链领域使用最广泛的两个共识引擎。**在 PoW 系统中，“矿工”为了成为下一个区块生产者而在竞争中消耗物理资源 (时间和能源)。这种外部资源的消耗给 Pow 网络带来了安全性。如果一个恶意的参与者希望停止或更改网络的状态，则将需要控制网络 50% 以上的算力**。

**在 PoS 系统中，对物理资源 (算力) 的竞争被*吸引区块链原生加密货币的竞争*所取代**。与 PoW 相比，这一关键差异使得 PoS 网络在不消耗大量电力的情况下运行，并允许更广泛地参与共识过程 (也即允许网络实现更好的去中心化)。想要成为网络验证者的参与者必须质押 (锁定，Stacking) 一定数量的区块链网络原生加密货币，作为其诚实参与共识过程的承诺。网络中质押的总价值为网络提供了安全性，这使得在 PoS 网络中不同形式的 51% 攻击的成本要比 PoW 更加昂贵。

除了主要作为安全屏障之外，验证者的质押金之所以非常重要还有两个原因：

1. 验证者质押量的多少与其被选中负责将新的交易添加到账本中的概率成正比，因此影响着该验证者能够赚取多少奖励。
2. 验证者的质押金还充当了抵押品，用来抑制不良行为：即如果对网络采取恶意行为，则通常会受到损失一部分质押金或在一段时间内失去参与共识过程的权利的惩罚。

总之，PoS 系统激励健康的网络行为。验证者会为了获得更大比例的区块奖励而质押更多抵押品。质押的抵押品越多，验证者就越有可能会遵守网络规范 (以避免被惩罚)，从而确保了区块链的安全性。

### STaaS 的兴起

#### 参与质押的动机

通过上述对 PoS 共识如何运作的基本技术理解，我们可以探索它所创造的经济机会。PoS 网络通过奖励验证者**区块奖励** (由网络原生货币的通胀和交易费组成)，从而激励质押者为网络的安全性做出贡献。

通胀奖励可以被视为 PoS 网络为了鼓励用户将自己的资产质押到网络中而使用的*本地激励机制*。而对于那些选择持有 PoS 网络的原生货币而不将资产质押进网络中的用户而言，将会受到该资产通胀供应计划所带来的稀释影响。

如果 100% 的原生货币被质押到网络中，那么网络所有权将不会发生相对变化，因为所有的通胀奖励都会被分配给所有现有的持有者；但考虑到这将意味着没有人在网络上实际运行应用程序或者进行交易，因此*这种情况是非常不可能发生的*。

因此，每个 PoS 网络都呈现出不同的活跃**质押率** (staking rate)，如下图所示，每个 PoS 网络的质押率取决于各自网络中的活动量和激励机制。

#### 参与质押的障碍

如果参与质押是 PoS 网络中原生的收益渠道，那么为何不是每个人都会运行一个验证者 (节点) 呢？其中有几个因素在起作用。

首先，成为一名验证者通常有一个**最低资本要求**，这最终让大多数的散户用户望而却步。

下图展示了在各个 PoS 网络中运行一个验证者节点的前期资本和硬件要求：

![各大 PoS 网络中运行一名验证者节点的前期资本和硬件要求](https://mmbiz.qpic.cn/sz_mmbiz_png/tsoSYGv5wmM5eYHHlfKBewPicic8A19oktXwuI7UfTNvQOj70EJc4gKiartvRm7kTSlWnCpib2rCBJd5OdOxWZHpcA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

其次，如果某个参与者有足够的资本来满足了 PoS 网络的*最低质押门槛*，那么他就需要承担 **确保验证者始终在线并正确运行** 的任务。大多数 PoS 网络会使用罚没 (slashing) 惩罚来惩罚离线或行为不端的验证者。

最后，参与 PoS 质押还伴随着 **机会成本**，也即资产被锁定一段时间，不能用于其他目的 (比如用于在 DeFi 中进行借贷)。这个问题适用于大多数使用了抵押担保 Staking 机制的 PoS 网络，但在像 Cardano 这样支持本地流动性质押的网络中避免了这个问题。

#### STaas提供商

最初创建 STaaS 行业的目的是为大众提供参与 Staking 的经济利益，同时为非技术用户解决持续的验证者节点维护挑战。随着该行业的成熟，我们已经开始看到了**流动性 staking 衍生品**的加入 (注：比如用户通过流动性质押协议 [Lido Finance](https://mp.weixin.qq.com/s?__biz=MzU2MDE2MDU3Mg==&mid=2247506520&idx=1&sn=2067df37bcc023e9501c6ad1399c5e56&scene=21#wechat_redirect) 质押 ETH 之后，可以 1:1 获得具有流动性的衍生品 stETH)，以帮助用户抵押因质押 (锁定) 资产而带来的机会成本。

STaaS 是一个相对简单的业务模型——用户将其资产转给或委托给管理一组验证者的 **STaaS 提供商**。这允许小型用户能够享受到参与 staking 的权益。通过使用 STaaS 提供商，用户可以轻松地通过点击几次鼠标来质押几乎任何 PoS 资产。

作为为其客户维护必要的验证者服务的回报，**STaaS 提供商会向其客户收取费用**。这可以是每月固定的费用，但更常见的是客户质押所产生回报的百分比 (这类佣金通常在客户质押回报的 5 - 20% 之间)。随着时间的推移，我们可以预期该费用百分比会降低，因为将会有更多的 STaaS 提供商加入这个生态系统并展开竞争。此外，随着 PoS 协议的成熟和缩减其奖励计划，每个客户为 STaaS 协议带来的名义费用预计将会下降。

#### 流动性质押解决方案

由于参与 staking (质押) 意味着对 PoS 网络的安全性做出承诺，因此质押的资产需要被锁定，以防止“银行挤兑”场景，即防止所有质押金被快速撤走并导致网络安全崩溃。每个 PoS 网络的锁定期各有不同。比如，在 Solana 网络中解除质押只需 2 天时间，而 Eth2 中的质押金将被无限期锁定，直到完成向 PoS 的过渡。

流动性质押 (liquid staking) 为质押者提供了一种**衍生品资产**，*代表了他们的质押头寸和产生质押奖励，且可以用于进行交易或作为 DeFi 活动的抵押品*。虽然流动性质押是托管类 STaaS 提供商和非托管类 STaaS 提供商都可能会为其客户提供的这项功能，但这种方式最常用于***去中心化质押池\****(staking pools)*。这些质押池协议本身并不会运行验证者节点，相反，它们积累用户的质押存款并将这些存款分配至已经在特定的 PoS 网络中运行的验证者节点上。因此，*在质押池中，奖励和惩罚通常是由所有存款人 (质押者) 共享/共担的*。



## 参看

- [《精通以太坊——实现数字合约》 中文版](https://www.8btc.com/books/834/ethereum-book/_book/)
- [一文读懂 Staking 即服务：机遇与风险，现状与未来](https://mp.weixin.qq.com/s/hnQOFvbqcAiSdsydURs4Ag)

