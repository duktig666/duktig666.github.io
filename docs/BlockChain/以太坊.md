---
title: 以太坊
date: 2022-03-23
publish: false
---

## 一些概念

以太坊的目的主要不是数字货币支付网络。但数字货币*ether*对于以太坊的运作来说既是不可或缺的也是必要的，以太也被视为一种*实用货币*来支付以太坊平台的使用。

与具有非常有限的脚本语言的比特币不同，以太坊被设计成一个通用可编程区块链，运行一个*虚拟机*，能够执行任意和无限复杂的代码。

以比特币为基础意味着处于网络的有意约束之中，并试图找到解决方法。数据存储的有限类型和大小似乎限制了可以在其上作为第二层解决方案运行的应用程序的类型。

将以太坊视为**构建可编程金钱的平台**。

以太坊的创始人们正在考虑一个**并非针对特定目的的区块链，而是通过成为*可编程的*来支持各种各样的应用**。





原始区块链（比特币的区块链）追踪比特币单位的状态及其所有权。你可以将比特币视为分布式共识 *状态机*，其中交易引起全局的_状态转移 _，从而更改比特币的所有权。状态转移受共识规则的制约，允许所有参与者（最终）在开采数个区块后在系统的共同（共识）状态上汇合。

以太坊也是一个分布式状态机。但是，**不仅仅追踪货币所有权的状态，以太坊追踪通用数据存储的状态转换**。



以太坊的突破性创新是将存储程序计算机的通用计算架构与去中心化区块链相结合，从而创建分布式单状态（单例）世界计算机。以太坊程序“到处”运行，但却产生了共识规则所保证的共同（共识）状态。



以太坊是图灵完备的事实意味着任何复杂的程序都可以在以太坊中计算。但是这种灵活性带来了一些棘手的安全和资源管理问题。

为了应对这一挑战，以太坊引入了称为 *燃气* *gas*的计量机制。随着EVM执行智能合约，它会仔细考虑每条指令（计算，数据访问等）。每条指令都有一个以燃气为单位的预定成本。当交易触发智能合约的执行时，它必须包含一定量的燃气，用以设定运行智能合约可消耗的计算上限。如果计算所消耗的燃气量超过交易中可用的天然气量，则EVM将终止执行。Gas是以太坊用于允许图灵完备计算的机制，同时限制任何程序可以使用的资源。



在比特币中，开发以保守原则为指导：所有变化都经过仔细研究，以确保现有系统都不会中断。大部分情况下，只有在向后兼容时才会执行更改。允许现有客户“选择加入”，但如果他们决定不升级，将继续运作。

相比之下，在以太坊中，开发文化的重点是速度和创新。这个咒语是“快速行动，解决事情”。如果需要进行更改，即使这意味着使之前的假设失效，破坏兼容性或强制客户端进行更新，也会执行更改。以太坊的开发文化的特点是快速创新，快速进化和愿意参与实验。

这对开发者来说意味着什么，**就是你必须保持灵活性，随着一些潜在的假设变化，准备重建你的基础设施**。



## 基础

以太坊的货币单位称为 *以太* *ether*，也被称为ETH。以太被细分为更小的单位，直到可能的最小单位，这被命名为*wei*，一个 ether 是 1×10^18^ 。

你可能会听到人们也提到货币“以太坊”，但这是一个常见的初学者的错误。**以太坊是制度，以太是货币**。

以太坊钱包是你通往以太坊系统的门户。它拥有你的密钥，并且可以代表你创建和广播交易。



**为什么交易不成功？**

你可能注意到你无法完成交易。MetaMask表示“交易余额不足”。乍一看这可能会让人困惑：我们有1个ETH，我们想要发送1个ETH，为什么MetaMask说我们没有足够的资金？

答案是因为*gas*的成本。以太坊交易需要支付矿工收取的费用，以验证交易。以太坊的费用以*gas*虚拟货币收取。作为交易的一部分，你使用ether支付gas。



小结：

**以太坊合约是控制货币的程序，运行在名为EVM的虚拟机内。它们是由一个特殊的交易创建的，该交易提交它们的字节码以记录在区块链中。一旦他们在区块链上创建，他们就拥有一个以太坊地址，就像钱包一样**。

**只要有人将交易发送到合约地址，它就会导致合约在EVM中运行，并将交易作为其输入。发送到合约地址的交易可能包含以太坊或数据或两者都有。如果它们含有ether，则将其“存入”合约余额。如果它们包含数据，则数据可以在合约中指定一个命名函数并调用它，并将参数传递给该函数。**



## 以太坊客户端

以太坊客户端是实现以太坊规范并通过对等网络与其他以太坊客户端进行通信的软件应用程序。

[go-ethereum](https://github.com/ethereum/go-ethereum)

构建（linuix）：

```sh
cd go-ethereum
make geth
```

[Win10使用Geth客户端搭建以太坊私有链](https://blog.csdn.net/Tree_sea/article/details/121990419)



### JSON-RPC接口

以太坊客户端提供应用程序编程接口（API）和一组远程过程调用（RPC）命令，这些命令被编码为JavaScript对象表示法（JSON）。这被称为*JSON-RPC API*。本质上，JSON-RPC API是一个接口，允许我们将使用以太坊客户端的程序作为*gateway*编写到以太坊网络和区块链中。

通常，RPC接口作为端口8545上的HTTP服务提供。

要访问JSON-RPC API，可以使用专门的库，用你选择的编程语言编写，它提供与每个可用的RPC命令相对应的“桩（stub）”函数调用。

测试：

```sh
curl -X POST -H "Content-Type: application/json" --data \
'{"jsonrpc":"2.0","method":"web3_clientVersion","params":[],"id":1}' \
http://localhost:8545
```

结果：

```json
{"jsonrpc":"2.0","id":1,
 "result":"Geth/v1.8.0-unstable-02aeb3d7/linux-amd64/go1.8.3"}
```



## 秘钥和地址

以太坊有两种不同类型的账户，可以拥有和控制ether：*外部所有账户*（EOA）和*合同*。

EOAs中以太的所有权通过 *数字密钥* *digital keys*，*以太坊地址*和*数字签名* 建立 。**数字密钥实际上并不存储在区块链中或在以太坊网络上传输，而是由用户创建并存储在文件或称为*钱包*的简单数据库中**。用户钱包中的数字密钥完全独立于以太坊协议，可以由用户的钱包软件生成和管理，无需参考区块链或访问互联网。数字密钥可实现以太坊的许多有趣特性，包括去中心化的信任和控制以及所有权证明。

以太坊交易需要将有效的数字签名包含在区块链中，该签名只能使用密钥生成；因此，任何拥有该密钥副本的人都可以控制ether。**以太坊交易中的数字签名证明了资金的真正所有者**。

**数字密钥成对组成，密钥和公钥。将公钥视为类似于银行帐号，私钥类似于私密PIN，用于控制帐户**。以太坊的用户很少看到这些数字密钥。在大多数情况下，它们存储在钱包文件内并由以太坊钱包软件管理。

以太坊在许多地方使用*Keccak-256*加密哈希函数。



以太坊地址是 *唯一标识符* *unique identifiers*，它们是使用单向哈希函数（Keccak-256）从公钥或合约派生的。

以太坊地址是十六进制数字，从公钥的Keccak-256哈希的最后20个字节导出的标识符。

## 钱包

关于以太坊的一个常见误解是以太坊钱包包含ether或代币。实际上，钱包只包含密钥。ether或其他代币记录在以太坊区块链中。用户通过使用钱包中的密钥签署交易来控制网络上的代币。从某种意义上说，以太坊钱包是一个 *钥匙串* *keychain*。

有两种主要类型的钱包，通过它们包含的密钥是否彼此相关来区分。

第一种类型是 *非确定性钱包* *nondeterministic wallet*，其中每个密钥都是从随机数中独立生成的。密钥不相互关联。这种类型的钱包也被称为“Just a Bunch Of Keys”，JBOK钱包。

第二种类型的钱包是 *确定性钱包* *deterministic wallet*，其中所有密钥都来自单个主密钥，称为*种子* *seed*。这种类型的钱包中的所有钥匙都是相互关联的，如果有原始种子，可以再次生成。确定性钱包中使用了许多不同的 *密钥推导方法。最常用的派生方法使用树状结构，称为 _分层确定* *hierarchical deterministic*或*HD*钱包。

确定性钱包是从种子初始化的。为了使这些更容易使用，种子被编码为一些英文单词（或其他语言的词），称为 *mnemonic code* 助记词，接下来的几节将从较高的层次介绍这些技术。

## 交易

**交易是由外部所有帐户发起的签名消息，由以太坊网络传输，并在以太坊区块链上进行记录（挖掘）**。

看待交易的另一种方式是，它们是唯一可触发状态更改或导致合约在EVM中执行的东西。以太坊是一个全球的单实例状态机器，交易是唯一可以让状态机“运动”，改变状态的东西。合约不会自行运行。以太坊不会在后台运行。一切都始于交易。

### 交易的结构

交易是一个序列化的二进制消息，其中包含以下数据：

- nonce

  由始发EOA（外部所有账户）发出的序列号，用于防止消息重播。

- gas price

  发起人愿意支付的gas价格（以wei为单位）。

- start gas

  发起人愿意支付的最大gas量。

- to

  目标以太坊地址。

- value

  发送到目标地址的ether数量。

- data

  变长二进制数据。

- v,r,s

  始发EOA的ECDSA签名的三个组成部分。

### 交易随机数

nonce是交易中最重要和最少被理解的组成部分之一。

nonce：与此地址发送的交易数量相等的标量值，或者，对于具有关联代码的帐户，表示此帐户创建的合约数量。

严格地说，nonce是始发地址的一个属性（它只在发送地址的上下文中有意义）。但是，该nonce并未作为账户状态的一部分显式存储在区块链中。相反，它是根据来源于此地址的已确认交易的数量动态计算的。

**nonce值也用于防止帐户余额的错误计算**。

**跟踪nonce**：

实际上，nonce是源自帐户的 *已确认*（已开采）交易数量的最新计数。要找到nonce是什么，你可以询问区块链，例如通过web3界面：

Retrieving the transaction count of our example address：

```
web3.eth.getTransactionCount("0x9e713963a92c02317a681b9bb3065a8249de124f")
40
```

该nonce是一个基于零的计数器，意味着第一个交易的nonce是0.在 [Retrieving the transaction count of our example address](https://www.8btc.com/books/834/ethereum-book/_book/第七章.html#nonce_getTransactionCount)中，我们有一个交易的计数为40，这意味着从0到39nonce已经被看到。下一个交易的nonce将是40。

你的钱包将跟踪其管理的每个地址的nonce。

**nonce的间隔，重复的nonce和确认**：

如果你正在以编程方式创建交易，跟踪nonce是十分重要的，特别是如果你同时从多个独立进程执行此操作。

以太坊网络根据nonce顺序处理交易。这意味着如果你使用nonce 0传输一个交易，然后传输一个具有nonce 2的交易，则第二个交易将不会被挖掘。它将存储在mempool中，以太坊网络等待丢失的nonce出现。所有节点都会假设缺少的nonce只是延迟了，具有nonce 2的交易被无序地接收到。

这意味着如果你按顺序创建多个交易，并且其中一个交易未被挖掘，则所有后续交易将“卡住”，等待丢失的事件。

**并发，交易的发起和随机数**

现在，假设我们有多个独立的钱包应用程序正在从同一个地址或同一组地址生成交易。这种情况的一个例子是从热钱包进行提款的交易所。理想情况下，你希望有多台计算机处理提款，以便它不会成为瓶颈或单点故障。然而，这很快就会成为问题，因为有多台计算机生产提款会导致一些棘手的并发问题，其中最重要的是选择nonce。多台电脑如何从同一个热钱包账户协调生成，签署和广播交易？

### 交易gas

**gas是以太坊的燃料。gas不是ether，它是独立的虚拟货币，有相对于ether的汇率**。

以太坊使用gas来控制交易可以花费的资源量，因为它将在全球数千台计算机上处理。开放式（图灵完备的）计算模型需要某种形式的计量，以避免拒绝服务攻击或无意中的资源吞噬交易。

gas与ether分离，以保护系统免受随着ether价值快速变化而产生的波动。

钱包可以在他们发起的交易中调整 gasPrice，以更快地确认（挖掘）交易。gasPrice 越高，交易可能被验证的速度越快。相反，较低优先级的交易可能会降低他们愿意为gas支付的价格，导致确认速度减慢。可以设置的最低gasPrice 为零，这意味着免费的交易。在区块空间需求低的时期，这些交易将被开采。

### 交易的接收者

交易的收件人在to字段中指定。这包含一个20字节的以太坊地址。地址可以是EOA或合约地址。

以太坊没有进一步验证这个字段。任何20字节的值都被认为是有效的。如果20字节的值对应于没有相应私钥的地址，或没有相应的合约，则该交易仍然有效。以太坊无法知道某个地址是否是从公钥（从私钥导出的）正确导出的。

### 交易的价值和数据

**交易的主要“负载”包含在两个字段中：value 和 data**。交易可以同时具有value和data，只有value，只有data，或没有value和data。所有四种组合都是有效的。

**将value传递给EOA和合约：**

当你构建包含 value 的以太坊交易时，它等同于*payment*。

对于未在区块链中注册为合约的任何地址，以太坊将记录状态更改，并将你发送的value添加到地址的余额中。如果地址之前没有被查看过，则会创建地址并将其余额初始化为你的付款value。

**将数据传输到EOA或合约**：

现在，假设你的交易是向合约地址提供 data。在这种情况下，data 将被EVM解释为 *函数调用* *function invocation*，调用指定的函数并将任何编码参数传递给该函数。

### 特殊交易：合约注册

有一种特殊的带有data，没有value的交易。表示注册一个新的合约。合约登记交易被发送到一个特殊的目的地地址，即零地址。简而言之，合约注册交易中的to字段包含地址 0x0。该地址既不代表EOA（没有相应的私人/公共密钥对）也不代表合约。它永远不会花费ether或启动交易。它仅用作目的地，具有“注册此合约”的特殊含义。

### 数字签名

数字签名在以太坊中有三种用途（请参阅下面的边栏）。首先，签名证明私钥的所有者，暗示着以太坊账户的所有者，已经授权支付ether或执行合约。其次，授权的证明是*undeniable*（不可否认）。第三，签名证明交易数据在交易签名后没有也不能被任何人修改。

数字签名是一种数学签名，由两部分组成。第一部分是使用私钥（签名密钥）从消息（交易）中创建签名的算法。第二部分是允许任何人仅使用消息和公钥来验证签名的算法。









## 参看

- [《精通以太坊——实现数字合约》 中文版](https://www.8btc.com/books/834/ethereum-book/_book/)

